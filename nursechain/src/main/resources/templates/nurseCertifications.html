<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>護士證書管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        form label {
            grid-column: span 1;
            align-self: center;
        }
        form input[type="text"],
        form input[type="number"],
        form input[type="datetime-local"],
        form select {
            width: calc(100% - 16px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        form button {
            grid-column: span 2;
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        form button:hover {
            background-color: #218838;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-edit {
            background-color: #007bff;
            color: white;
        }
        .btn-edit:hover {
            background-color: #0056b3;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-toBlockChain {
            background-color: #289356ff;
        }
        .btn-toBlockChain:hover {
            background-color: #1e6e40;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tbody tr:hover {
            background-color: #ddd;
        }
        #loading {
            text-align: center;
            color: #555;
            font-style: italic;
        }
        #message {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>護士證書管理</h1>

        <h2>新增/編輯護士證書</h2>
        <form id="certificationForm">
            <input type="hidden" id="certificationId">
            <label for="nurseId">護士ID:</label>
            <input type="number" id="nurseId" required>

            <label for="categorySelect">科目類別:</label>
            <select id="categorySelect" required>
                <option value="">請選擇類別</option>
            </select>

            <label for="subjectSelect">科目名稱:</label>
            <select id="subjectSelect" required disabled>
                <option value="">請先選擇類別</option>
            </select>
            
            <input type="hidden" id="subjectId"> <label for="startTime">開始時間:</label>
            <input type="datetime-local" id="startTime" required>

            <label for="endTime">結束時間:</label>
            <input type="datetime-local" id="endTime" required>

            <label for="points">積分:</label>
            <input type="number" step="0.1" id="points" required>

            <label for="unit">單位:</label>
            <input type="text" id="unit" readonly>

            <button type="submit" id="submitBtn">新增證書</button>
        </form>
        <div id="message"></div>
    </div>

    <div class="container">
        <h2>護士證書列表</h2>
        <div id="loading">載入中...</div>
        <table id="certificationsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>護士ID</th>
                    <th>護士姓名</th>
                    <th>科目ID</th>
                    <th>科目名稱</th>
                    <th>開始時間</th>
                    <th>結束時間</th>
                    <th>積分</th>
                    <th>開課單位</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        const apiUrl = 'http://120.110.115.123:8081/api/nursecertifications';
        const subjectApiUrl = 'http://120.110.115.123:8081/api/subjects'; // 獲取所有科目數據
        const tableBody = document.querySelector('#certificationsTable tbody');
        const loadingDiv = document.getElementById('loading');
        const messageDiv = document.getElementById('message');
        const certificationForm = document.getElementById('certificationForm');
        const submitBtn = document.getElementById('submitBtn');
        const certificationIdInput = document.getElementById('certificationId');
        
        const categorySelect = document.getElementById('categorySelect'); // 新增類別下拉選單
        const subjectSelect = document.getElementById('subjectSelect'); // 科目下拉選單
        const subjectIdInput = document.getElementById('subjectId'); // 隱藏的 subjectId 輸入框
        const unitInput = document.getElementById('unit'); // 單位輸入框

        let allSubjects = []; // 儲存所有科目數據

        // 輔助函數：顯示訊息
        function showMessage(msg, type = 'success') {
            messageDiv.textContent = msg;
            messageDiv.className = type;
            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 3000);
        }

        // 輔助函數：清除表單
        function clearForm() {
            certificationForm.reset();
            certificationIdInput.value = '';
            categorySelect.value = ''; // 清空類別選擇
            subjectSelect.innerHTML = '<option value="">請先選擇類別</option>'; // 重置科目下拉選單
            subjectSelect.disabled = true; // 禁用科目下拉選單
            subjectIdInput.value = '';
            unitInput.value = '';
            submitBtn.textContent = '新增證書';
            submitBtn.style.backgroundColor = '#28a745';
        }

        // 載入所有科目數據 (包括 category 和 unit)
        async function loadAllSubjectsData() {
            try {
                const response = await fetch(subjectApiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allSubjects = await response.json(); // 儲存所有科目數據

                // 提取所有不重複的 category
                const categories = [...new Set(allSubjects.map(s => s.category))];
                categorySelect.innerHTML = '<option value="">請選擇類別</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });

            } catch (error) {
                console.error('獲取科目數據時出錯:', error);
                showMessage('載入科目數據失敗！', 'error');
            }
        }

        // 根據選擇的 category 填充 subject 下拉選單
        categorySelect.addEventListener('change', function() {
            const selectedCategory = this.value;
            subjectSelect.innerHTML = '<option value="">請選擇科目</option>';
            subjectIdInput.value = ''; // 清空科目ID
            unitInput.value = ''; // 清空單位

            if (selectedCategory) {
                subjectSelect.disabled = false; // 啟用科目下拉選單
                const filteredSubjects = allSubjects.filter(s => s.category === selectedCategory);
                filteredSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.subjectName;
                    subjectSelect.appendChild(option);
                });
            } else {
                subjectSelect.disabled = true; // 禁用科目下拉選單
                subjectSelect.innerHTML = '<option value="">請先選擇類別</option>';
            }
        });

        // 處理 subject 選擇變化，自動帶出 unit
        subjectSelect.addEventListener('change', function() {
            const selectedSubjectId = this.value;
            subjectIdInput.value = selectedSubjectId; // 更新隱藏的 subjectId

            if (selectedSubjectId) {
                const selectedSubject = allSubjects.find(s => s.id == selectedSubjectId);
                if (selectedSubject) {
                    unitInput.value = selectedSubject.unit || '';
                    points.value = selectedSubject.points||'';
                }
            } else {
                unitInput.value = '';
            }
        });

        // 載入護士證書列表
        async function loadCertifications() {
            loadingDiv.style.display = 'block';
            tableBody.innerHTML = '';

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                loadingDiv.style.display = 'none';

                if (data && data.length > 0) {
                    data.forEach(cert => {
                        const row = tableBody.insertRow();
                        row.setAttribute('data-id', cert.id);
                        row.insertCell().textContent = cert.id;
                        row.insertCell().textContent = cert.nurseId;
                        row.insertCell().textContent = cert.nurseName;
                        row.insertCell().textContent = cert.subjectId;
                        row.insertCell().textContent = cert.subjectName;
                        row.insertCell().textContent = cert.startTime ? new Date(cert.startTime).toLocaleString() : '';
                        row.insertCell().textContent = cert.endTime ? new Date(cert.endTime).toLocaleString() : '';
                        row.insertCell().textContent = cert.points;
                        row.insertCell().textContent = cert.unit; // 顯示 unit

                        const actionsCell = row.insertCell();
                        const editButton = document.createElement('button');
                        editButton.textContent = '編輯';
                        editButton.className = 'btn-edit';
                        editButton.onclick = () => editCertification(cert);
                        actionsCell.appendChild(editButton);

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = '刪除';
                        deleteButton.className = 'btn-delete';
                        deleteButton.onclick = () => deleteCertification(cert.id);
                        actionsCell.appendChild(deleteButton);

                        const toBlockChain = document.createElement('button');
                        toBlockChain.textContent = '上鏈';
                        toBlockChain.className = 'btn-toBlockChain';
                        toBlockChain.onclick = () => toBlockchain();
                        actionsCell.appendChild(toBlockChain);
                    });
                } else {
                    const row = tableBody.insertRow();
                    const cell = row.insertCell();
                    cell.colSpan = 10;
                    cell.textContent = '沒有找到護士證書數據。';
                    cell.style.textAlign = 'center';
                }
            } catch (error) {
                console.error('獲取護士證書數據時出錯:', error);
                loadingDiv.textContent = '載入數據失敗，請檢查控制台。';
                loadingDiv.style.color = 'red';
            }
        }

        // 表單提交處理 (新增或更新)
        certificationForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const id = certificationIdInput.value;
            const nurseId = document.getElementById('nurseId').value;
            const selectedSubjectId = subjectIdInput.value; // 從隱藏的輸入框獲取 subjectId
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const points = document.getElementById('points').value;

            if (!selectedSubjectId) {
                showMessage('請選擇一個科目！', 'error');
                return;
            }

            const certificationData = {
                nurseId: parseInt(nurseId),
                subjectId: parseInt(selectedSubjectId),
                startTime: startTime,
                endTime: endTime,
                points: parseFloat(points)
            };

            let response;
            try {
                console.log(certificationData)
                if (id) {
                    response = await fetch(`${apiUrl}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(certificationData)
                    });
                    if (response.ok) {
                        showMessage('證書更新成功！');
                    } else {
                        throw new Error(`更新失敗: ${response.statusText}`);
                    }
                } else {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(certificationData)
                    });
                    if (response.ok) {
                        showMessage('證書新增成功！');
                    } else {
                        throw new Error(`新增失敗: ${response.statusText}`);
                    }
                }
                clearForm();
                loadCertifications();
            } catch (error) {
                console.error('操作失敗:', error);
                showMessage(error.message, 'error');
            }
        });

        // 編輯功能：將數據填充到表單
        async function editCertification(cert) {
            certificationIdInput.value = cert.id;
            document.getElementById('nurseId').value = cert.nurseId;
            
            // 載入所有科目數據以確保下拉選單已填充
            await loadAllSubjectsData(); 

            // 設定 category 下拉選單的值
            const selectedSubject = allSubjects.find(s => s.id == cert.subjectId);
            if (selectedSubject) {
                categorySelect.value = selectedSubject.category;
                // 觸發 category 的 change 事件來填充 subjectSelect
                categorySelect.dispatchEvent(new Event('change')); 
                
                // 設定 subject 下拉選單的值
                subjectSelect.value = cert.subjectId;
                subjectIdInput.value = cert.subjectId; // 同步隱藏的 subjectId
                unitInput.value = selectedSubject.unit || ''; // 自動帶出 unit
            } else {
                // 如果找不到科目，則清空相關欄位
                clearForm(); 
                showMessage('編輯的科目不存在，請重新選擇。', 'error');
            }

            document.getElementById('startTime').value = cert.startTime ? new Date(cert.startTime).toISOString().slice(0, 16) : '';
            document.getElementById('endTime').value = cert.endTime ? new Date(cert.endTime).toISOString().slice(0, 16) : '';
            document.getElementById('points').value = cert.points;
            
            submitBtn.textContent = '更新證書';
            submitBtn.style.backgroundColor = '#007bff';
        }

        // 刪除功能 (保持不變)
        async function deleteCertification(id) {
            if (confirm(`確定要刪除 ID 為 ${id} 的證書嗎？`)) {
                try {
                    const response = await fetch(`${apiUrl}/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        showMessage('證書刪除成功！');
                        loadCertifications();
                    } else {
                        throw new Error(`刪除失敗: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('刪除操作失敗:', error);
                    showMessage(error.message, 'error');
                }
            }
        }

        // 假設的 toBlockchain 函數 (保持不變)
        async function toBlockchain() {
            showMessage('上鏈功能待實現...', 'info');
            console.log('執行上鏈操作');
        }

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllSubjectsData(); // 先載入所有科目數據（包括類別和名稱）
            await loadCertifications(); // 再載入證書列表
        });
    </script>
</body>
</html>